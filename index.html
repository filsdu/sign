<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Campaign Board</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        // Main Enhanced Campaign Board Component
        function EnhancedCampaignBoard() {
            // State management
            // Campaigns are now loaded from Supabase instead of being hard‑coded.  An empty array is used as the default state
            // until the asynchronous fetch completes.  Once campaigns are fetched, the first active campaign will be selected automatically.
            const [campaigns, setCampaigns] = React.useState([]);
            const [activeCampaign, setActiveCampaign] = React.useState(null);
            const [confessions, setConfessions] = React.useState([]);
            const [confessionText, setConfessionText] = React.useState('');
            const [textColor, setTextColor] = React.useState('#000000');
            const [boundaryColor, setBoundaryColor] = React.useState('#ffffff');
            const [fontFamily, setFontFamily] = React.useState('Arial');
            const [fontSize, setFontSize] = React.useState(16);
            const [rotation, setRotation] = React.useState(0);
            const [displayName, setDisplayName] = React.useState('');
            const [zoom, setZoom] = React.useState(0.5);
            const [userMessage, setUserMessage] = React.useState('');
            const [shownConfessionId, setShownConfessionId] = React.useState(null);
            const [placementMode, setPlacementMode] = React.useState('auto');
            const [pendingManualSpot, setPendingManualSpot] = React.useState(null);
            const [isWritingDirectly, setIsWritingDirectly] = React.useState(false);
            const [directWritingText, setDirectWritingText] = React.useState('');
            const [directWritingPosition, setDirectWritingPosition] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [showAdminPanel, setShowAdminPanel] = React.useState(false);
            const [uploadedImage, setUploadedImage] = React.useState(null);
            const [editingPostId, setEditingPostId] = React.useState(null);
            const [editTextColor, setEditTextColor] = React.useState('#000000');
            const [editBoundaryColor, setEditBoundaryColor] = React.useState('#ffffff');
            const [editFontFamily, setEditFontFamily] = React.useState('Arial');
            const [editFontSize, setEditFontSize] = React.useState(16);
            const [editRotation, setEditRotation] = React.useState(0);
            const [timeLapseMode, setTimeLapseMode] = React.useState(false);
            // Track whether the time‑lapse modal is visible.  When true, the board is shown
            // in a full‑screen overlay with playback controls.
            const [showTimeLapseModal, setShowTimeLapseModal] = React.useState(false);
            const [timeLapseProgress, setTimeLapseProgress] = React.useState(100);
            const [timeLapsePlaying, setTimeLapsePlaying] = React.useState(false);
            const nameTimeoutRef = React.useRef(null);
            const timeLapseIntervalRef = React.useRef(null);

            // Derive the highest like count among all confessions.  This value is used to
            // highlight the most liked post with a bounce animation.  If there are no likes
            // yet, highestLikes will be zero and no posts will bounce.
            const highestLikes = React.useMemo(() => {
                if (!confessions || confessions.length === 0) return 0;
                return Math.max(...confessions.map(c => c.likes || 0), 0);
            }, [confessions]);

            // Constants
            const WALL_WIDTH = 10000;
            const WALL_HEIGHT = 8000;
            const MIN_CONFESSION_WIDTH = 100;
            const MAX_CONFESSION_WIDTH = 300;
            const MIN_CONFESSION_HEIGHT = 80;
            const MAX_CONFESSION_HEIGHT = 200;

            // -------------------------------------------------------------------------
            // Supabase initialization
            //
            // The board now persists campaigns and posts using Supabase.  The URL and
            // anonymous key below point at your Supabase project.  If these values
            // need to change in the future, update them here.  The supabase-js
            // library is loaded globally at the top of this document.
            // New Supabase credentials for TalkLoop project
            const SUPABASE_URL = 'https://swurygicmrkbdgqbzhmp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3dXJ5Z2ljbXJrYmRncWJ6aG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTE0NDUsImV4cCI6MjA3MTcyNzQ0NX0.u9IB0nxe2UmR3AOZ5-MY6_A_WJK-YY8Z9mF8EYBH3Gk';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // User session ID and nickname
            const [userId, userNickname] = React.useMemo(() => {
                let id = localStorage.getItem('campaignUserId');
                let nickname = localStorage.getItem('userNickname');
                
                if (!id) {
                    id = Math.random().toString(36).substring(2) + Date.now().toString(36);
                    localStorage.setItem('campaignUserId', id);
                }
                
                if (!nickname) {
                    nickname = `User${id.slice(-4)}`;
                    localStorage.setItem('userNickname', nickname);
                }
                
                return [id, nickname];
            }, []);

            // Check if the current user has already placed a confession in the active campaign.
            // Instead of a site‑wide check, this now validates on a per‑campaign basis.  If the
            // active campaign is null (e.g. while campaigns are still loading), no one is
            // considered to have posted.
            const userHasPosted = React.useMemo(() => 
                activeCampaign ? confessions.some(conf => conf.owner === userId && conf.campaign_id === activeCampaign.id) : false,
                [confessions, userId, activeCampaign]
            );

            // -------------------------------------------------------------------------
            // Supabase data loading
            //
            // Fetch the list of active campaigns once when the component mounts.  The
            // campaigns are ordered by their creation date so that older campaigns
            // appear first in the dropdown.  If no campaigns exist, the list will
            // remain empty and the UI will instruct the administrator to create one.
            React.useEffect(() => {
                const fetchCampaigns = async () => {
                    try {
                        const { data, error } = await supabaseClient
                            .from('campaigns')
                            .select('*')
                            .eq('is_active', true)
                            .order('created_at', { ascending: true });
                        if (error) {
                            console.error('Error fetching campaigns:', error);
                        } else {
                            setCampaigns(data);
                            // Automatically select the first campaign if none is currently active
                            if (!activeCampaign && data.length > 0) {
                                setActiveCampaign(data[0]);
                            }
                        }
                    } catch (err) {
                        console.error('Unexpected error fetching campaigns:', err);
                    }
                };
                fetchCampaigns();
            }, []);

            // When the active campaign changes, fetch its posts and set up a real‑time
            // subscription.  The subscription listens for INSERT, UPDATE and DELETE
            // events on the confessions table for the current campaign only.  On
            // unmount or when switching campaigns, the channel is removed to avoid
            // memory leaks.
            React.useEffect(() => {
                if (!activeCampaign) return;
                let ignore = false;
                const loadConfessions = async () => {
                    try {
                        const { data, error } = await supabaseClient
                            .from('confessions')
                            .select('*')
                            .eq('campaign_id', activeCampaign.id);
                        if (!ignore) {
                            if (error) {
                                console.error('Error fetching confessions:', error);
                            } else {
                                setConfessions(data || []);
                            }
                        }
                    } catch (err) {
                        if (!ignore) console.error('Unexpected error fetching confessions:', err);
                    }
                };
                loadConfessions();

                // Subscribe to real‑time changes for this campaign
                const channel = supabaseClient.channel('public:confessions')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'confessions',
                        filter: `campaign_id=eq.${activeCampaign.id}`
                    }, (payload) => {
                        const { eventType, new: newRow, old: oldRow } = payload;
                        if (eventType === 'INSERT') {
                            setConfessions(prev => {
                                // avoid duplicates if this post already exists
                                if (prev.some(c => c.id === newRow.id)) return prev;
                                return [...prev, newRow];
                            });
                        } else if (eventType === 'UPDATE') {
                            setConfessions(prev => prev.map(c => c.id === newRow.id ? { ...c, ...newRow } : c));
                        } else if (eventType === 'DELETE') {
                            setConfessions(prev => prev.filter(c => c.id !== oldRow.id));
                        }
                    })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            // Subscription active
                        }
                    });

                return () => {
                    ignore = true;
                    channel.unsubscribe();
                };
            }, [activeCampaign]);

            // -------------------------------------------------------------------------
            // Placement Engine
            //
            // This helper object calculates where to place each confession on the wall,
            // preventing overlaps by checking rotated bounding boxes.  It is used
            // for both auto and manual placement.  The engine can be replaced if
            // there are future improvements to placement logic.
            const PlacementEngine = {
                // Compute the bounding box of a rotated rectangle
                rotatedBounds(w, h, angle) {
                    const sin = Math.abs(Math.sin(angle));
                    const cos = Math.abs(Math.cos(angle));
                    const rw = w * cos + h * sin;
                    const rh = w * sin + h * cos;
                    return { rw, rh };
                },
                // Check if two rectangles overlap
                overlap(a, b) {
                    return !(
                        a.x + a.rw <= b.x ||
                        b.x + b.rw <= a.x ||
                        a.y + a.rh <= b.y ||
                        b.y + b.rh <= a.y
                    );
                },
                // Find a placement for a new post
                findPlacement({ wallWidth, wallHeight, itemW, itemH, rotRad, existing }) {
                    const { rw, rh } = this.rotatedBounds(itemW, itemH, rotRad);
                    for (let tries = 0; tries < 1000; tries++) {
                        const x = Math.random() * (wallWidth - rw);
                        const y = Math.random() * (wallHeight - rh);
                        const newRect = { x, y, rw, rh };
                        let collision = false;
                        for (const ex of existing) {
                            const { rw: erw, rh: erh } = this.rotatedBounds(ex.w, ex.h, ex.rot);
                            if (this.overlap(newRect, { x: ex.x, y: ex.y, rw: erw, rh: erh })) {
                                collision = true;
                                break;
                            }
                        }
                        if (!collision) {
                            return { x, y };
                        }
                    }
                    return null;
                }
            };

            // -------------------------------------------------------------------------
            // Campaign Data Helpers
            //
            // Determine whether a campaign is selected and accessible.  If no campaign is
            // active, certain UI elements will be disabled and the user will be prompted
            // to ask the admin to create one.
            const hasCampaign = Boolean(activeCampaign);
            const campaignDesc = activeCampaign ? activeCampaign.description : '';

            // Filter confessions by time‑lapse progress.  When time‑lapse mode is active,
            // only posts created at or before the selected percentage of campaign time are shown.
            const filteredConfessions = React.useMemo(() => {
                if (!timeLapseMode || !hasCampaign) return confessions;
                const now = new Date();
                const campaignStart = new Date(activeCampaign.created_at);
                const totalTime = now.getTime() - campaignStart.getTime();
                const threshold = campaignStart.getTime() + (totalTime * (timeLapseProgress / 100));
                return confessions.filter(conf => new Date(conf.created_at).getTime() <= threshold);
            }, [confessions, timeLapseMode, timeLapseProgress, hasCampaign, activeCampaign]);

            // -------------------------------------------------------------------------
            // UI Event Handlers
            //
            // Add new confession (text) to Supabase.  Supports auto and manual placement.
            const handlePlaceConfession = async () => {
                if (!activeCampaign) {
                    setUserMessage('Go to Admin to create your first campaign.');
                    return;
                }
                if (!confessionText.trim()) {
                    setUserMessage("Please write something first");
                    return;
                }
                
                setUserMessage("Finding the perfect spot for your post...");
                
                try {
                    // Calculate size based on text length
                    const textLength = confessionText.trim().length;
                    const words = confessionText.trim().split(' ');
                    const lineCount = Math.max(1, Math.ceil(textLength / 15));

                    const baseWidth = Math.max(
                        MIN_CONFESSION_WIDTH, 
                        Math.min(MAX_CONFESSION_WIDTH, 70 + textLength * 4)
                    );

                    const baseHeight = Math.max(
                        MIN_CONFESSION_HEIGHT, 
                        Math.min(MAX_CONFESSION_HEIGHT, 40 + lineCount * 20)
                    );

                    const w = Math.round(baseWidth);
                    const h = Math.round(baseHeight);
                    const rotDeg = Math.round(rotation);
                    const rotRad = (rotDeg * Math.PI) / 180;

                    let spot = null;
                    
                    if (placementMode === 'manual' && pendingManualSpot) {
                        // Try to place at the clicked spot
                        const { rw, rh } = PlacementEngine.rotatedBounds(w, h, rotRad);
                        const x = Math.max(0, Math.min(pendingManualSpot.x - rw / 2, WALL_WIDTH - rw));
                        const y = Math.max(0, Math.min(pendingManualSpot.y - rh / 2, WALL_HEIGHT - rh));
                        spot = { x, y };
                    } else {
                        // Auto placement using placement engine
                        const existing = confessions.filter(c => c.campaign_id === activeCampaign.id).map(c => ({
                            x: c.x,
                            y: c.y,
                            w: c.w,
                            h: c.h,
                            rot: c.rot
                        }));
                        const placement = PlacementEngine.findPlacement({
                            wallWidth: WALL_WIDTH,
                            wallHeight: WALL_HEIGHT,
                            itemW: w,
                            itemH: h,
                            rotRad,
                            existing
                        });
                        if (!placement) {
                            setUserMessage('Could not find space on the wall. Please try a different spot.');
                            return;
                        }
                        spot = placement;
                    }

                    const finalX = Math.round(spot.x);
                    const finalY = Math.round(spot.y);
                    const confessionData = {
                        id: `conf-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
                        campaign_id: activeCampaign.id,
                        owner: userId,
                        name: displayName || userNickname,
                        text: confessionText,
                        color: textColor,
                        boundary_color: boundaryColor,
                        font_family: fontFamily,
                        font_size: fontSize,
                        rot: rotRad,
                        x: finalX,
                        y: finalY,
                        w,
                        h,
                        created_at: new Date().toISOString(),
                        type: 'text',
                        likes: 0,
                        liked_by: []
                    };

                    const { error } = await supabaseClient
                        .from('confessions')
                        .insert([confessionData]);

                    if (error) {
                        console.error('Error inserting confession:', error);
                        setUserMessage('Failed to submit your post. Please try again.');
                        return;
                    }

                    setConfessions(prev => [...prev, confessionData]);
                    setConfessionText('');
                    setPendingManualSpot(null);
                    setUserMessage("Your post has been added to the campaign!");

                    // Wait a moment then center on your new post
                    setTimeout(() => {
                        locateMyConfession(true);
                    }, 500);
                } catch (err) {
                    console.error('Unexpected error placing confession:', err);
                    setUserMessage("Something went wrong. Please try again.");
                }
            };

            // Submit an uploaded image to the wall.  This function supports both
            // auto and manual placement modes.  If the user has selected a manual
            // spot, the image will be placed there.  Otherwise, the placement
            // engine will find an available position automatically.  Rotation
            // options and image dimensions are respected.  After the image is
            // posted, the local state and Supabase are updated and the upload
            // state is cleared.
            const handleSubmitImage = async () => {
                if (!activeCampaign || !uploadedImage || activeCampaign.type !== 'image') {
                    setUserMessage('Please upload an image first');
                    return;
                }
                if (userHasPosted) {
                    setUserMessage('You can only post once per campaign');
                    return;
                }
                // Standard size for images
                const w = 200;
                const h = 200;
                const rotRad = (rotation * Math.PI) / 180;
                const { rw, rh } = PlacementEngine.rotatedBounds(w, h, rotRad);
                let finalX, finalY;
                // Manual placement
                if (placementMode === 'manual' && pendingManualSpot) {
                    finalX = Math.max(0, Math.min(pendingManualSpot.x - rw / 2, WALL_WIDTH - rw));
                    finalY = Math.max(0, Math.min(pendingManualSpot.y - rh / 2, WALL_HEIGHT - rh));
                } else {
                    // Auto placement
                    const existing = confessions.filter(c => c.campaign_id === activeCampaign.id).map(c => ({
                        x: c.x,
                        y: c.y,
                        w: c.w,
                        h: c.h,
                        rot: c.rot
                    }));
                    const placement = PlacementEngine.findPlacement({
                        wallWidth: WALL_WIDTH,
                        wallHeight: WALL_HEIGHT,
                        itemW: w,
                        itemH: h,
                        rotRad,
                        existing
                    });
                    if (!placement) {
                        setUserMessage('Could not find space on the wall. Please try a different spot.');
                        return;
                    }
                    finalX = placement.x;
                    finalY = placement.y;
                }
                const confessionData = {
                    id: `conf-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    campaign_id: activeCampaign.id,
                    owner: userId,
                    image: uploadedImage,
                    x: Math.round(finalX),
                    y: Math.round(finalY),
                    w,
                    h,
                    rot: rotRad,
                    name: userNickname,
                    created_at: new Date().toISOString(),
                    type: 'image',
                    likes: 0,
                    liked_by: []
                };
                try {
                    const { error } = await supabaseClient
                        .from('confessions')
                        .insert([confessionData]);
                    if (error) {
                        console.error('Error inserting image post:', error);
                        setUserMessage('Failed to submit your image. Please try again.');
                        return;
                    }
                    setConfessions(prev => [...prev, confessionData]);
                    setUploadedImage(null);
                    setPendingManualSpot(null);
                    setUserMessage('Your image has been added to the campaign!');
                    setTimeout(() => {
                        locateMyConfession(true);
                    }, 500);
                } catch (err) {
                    console.error('Unexpected error inserting image post:', err);
                    setUserMessage('Something went wrong. Please try again.');
                }
            };

            // Handle editing an existing post.  This stores the ID being edited and
            // populates the edit form with that post's current settings.
            const handleEditConfession = (confId) => {
                const conf = confessions.find(c => c.id === confId);
                if (!conf) return;
                
                setEditingPostId(confId);
                setEditTextColor(conf.color || '#000000');
                setEditBoundaryColor(conf.boundary_color || '#ffffff');
                setEditFontFamily(conf.font_family || 'Arial');
                setEditFontSize(conf.font_size || 16);
                setEditRotation(Math.round((conf.rot * 180) / Math.PI));
            };

            // Save edited confession
            const handleSaveEdit = async () => {
                if (!editingPostId) return;
                const newRot = (editRotation * Math.PI) / 180;
                // Update local state immediately
                setConfessions(prev => prev.map(conf => {
                    if (conf.id === editingPostId) {
                        return {
                            ...conf,
                            color: editTextColor,
                            boundary_color: editBoundaryColor,
                            font_family: editFontFamily,
                            font_size: editFontSize,
                            rot: newRot
                        };
                    }
                    return conf;
                }));
                setEditingPostId(null);
                setUserMessage("Your post has been updated.");
                // Persist changes to Supabase
                try {
                    const { error } = await supabaseClient
                        .from('confessions')
                        .update({
                            color: editTextColor,
                            boundary_color: editBoundaryColor,
                            font_family: editFontFamily,
                            font_size: editFontSize,
                            rot: newRot
                        })
                        .eq('id', editingPostId);
                    if (error) {
                        console.error('Error saving edits:', error);
                        setUserMessage("Failed to update your post. Please try again.");
                    }
                } catch (err) {
                    console.error('Unexpected error updating confession:', err);
                    setUserMessage("Something went wrong. Please try again.");
                }
            };

            // Delete confession
            const handleRemoveConfession = async () => {
                if (!activeCampaign) {
                    setUserMessage('No active campaign to remove a post from.');
                    return;
                }
                if (!userHasPosted) {
                    setUserMessage("You haven't posted yet!");
                    return;
                }
                setUserMessage("Removing your post...");

                // Find the user's confession for the current campaign
                const userConf = confessions.find(conf => conf.owner === userId && conf.campaign_id === activeCampaign.id);

                if (!userConf) {
                    setUserMessage("You haven't posted in this campaign.");
                    return;
                }
                
                try {
                    await supabaseClient
                        .from('confessions')
                        .delete()
                        .eq('id', userConf.id);
                    
                    setConfessions(prev => prev.filter(conf => conf.id !== userConf.id));
                    setUserMessage("Your post has been removed.");
                } catch (err) {
                    console.error('Unexpected error removing post:', err);
                    setUserMessage('Failed to remove your post. Please try again.');
                }
            };

            // Handle liking a confession.  Users can like any post once; subsequent
            // clicks do nothing.  The like count and list of users who have liked
            // the post are persisted to Supabase.  The local state is updated
            // optimistically for immediate feedback.
            const handleLikeConfession = async (confId) => {
                const conf = confessions.find(c => c.id === confId);
                if (!conf) return;
                const likedBy = Array.isArray(conf.liked_by) ? conf.liked_by : [];
                // Do not allow duplicate likes
                if (likedBy.includes(userId)) {
                    return;
                }
                const newLikes = (conf.likes || 0) + 1;
                const newLikedBy = [...likedBy, userId];
                // Optimistically update local state
                setConfessions(prev => prev.map(c => {
                    if (c.id === confId) {
                        return { ...c, likes: newLikes, liked_by: newLikedBy };
                    }
                    return c;
                }));
                try {
                    await supabaseClient
                        .from('confessions')
                        .update({ likes: newLikes, liked_by: newLikedBy })
                        .eq('id', confId);
                } catch (err) {
                    console.error('Error updating like count:', err);
                }
            };

            // Handle wall click for manual placement
            const onWallClick = (e) => {
                if (!activeCampaign) return;
                if (placementMode === 'manual') {
                    const container = wallScrollRef.current;
                    const rect = container.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / zoom;
                    const y = (e.clientY - rect.top) / zoom;
                    setPendingManualSpot({ x, y });
                    setUserMessage(`Spot selected. Click "Post to Wall" to place your ${activeCampaign.type === 'text' ? 'post' : 'photo'}.`);
                }
            };

            // Toggle time‑lapse mode and open/close the modal
            const toggleTimeLapse = () => {
                setTimeLapseMode(prev => {
                    const newValue = !prev;
                    if (!newValue) {
                        setTimeLapsePlaying(false);
                        setShowTimeLapseModal(false);
                    } else {
                        setShowTimeLapseModal(true);
                    }
                    return newValue;
                });
            };

            // Fit to full content
            const fitToFullContent = () => {
                if (!hasCampaign) return;
                const container = wallScrollRef.current;
                const { offsetWidth: width, offsetHeight: height } = container;
                const contentWidth = WALL_WIDTH * zoom;
                const contentHeight = WALL_HEIGHT * zoom;
                const minX = 0;
                const minY = 0;
                // Center scroll
                const cx = minX + contentWidth / 2;
                const cy = minY + contentHeight / 2;
                const left = Math.max(0, cx - container.clientWidth / (2 * zoom));
                const top = Math.max(0, cy - container.clientHeight / (2 * zoom));
                container.scrollTo({ left, top, behavior: "smooth" });
            };

            // Locate the user's post
            const locateMyConfession = (smooth = true) => {
                if (!activeCampaign) return;
                const myConf = confessions.find(
                    conf => conf.owner === userId && conf.campaign_id === activeCampaign.id
                );
                if (!myConf) {
                    setUserMessage("You haven't posted yet!");
                    return;
                }
                const container = wallScrollRef.current;
                const elementX = myConf.x + myConf.w / 2;
                const elementY = myConf.y + myConf.h / 2;
                const scrollX = elementX * zoom - container.clientWidth / 2;
                const scrollY = elementY * zoom - container.clientHeight / 2;
                container.scrollTo({ left: scrollX, top: scrollY, behavior: smooth ? "smooth" : "auto" });
                setUserMessage("Located your post!");
                setShownConfessionId(myConf.id);
                clearTimeout(nameTimeoutRef.current);
                nameTimeoutRef.current = setTimeout(() => {
                    setShownConfessionId(null);
                }, 5000);
            };

            // Zoom controls
            const zoomIn = () => {
                const newZoom = Math.min(zoom + 0.1, 1);
                setZoom(newZoom);
            };
            const zoomOut = () => {
                const newZoom = Math.max(zoom - 0.1, 0.1);
                setZoom(newZoom);
            };

            // Start/stop playback for time‑lapse
            const toggleTimeLapsePlayback = () => {
                setTimeLapsePlaying(prev => {
                    const playing = !prev;
                    if (playing) {
                        timeLapseIntervalRef.current = setInterval(() => {
                            setTimeLapseProgress(prev => {
                                if (prev >= 100) {
                                    clearInterval(timeLapseIntervalRef.current);
                                    return prev;
                                }
                                return prev + 1;
                            });
                        }, 500);
                    } else {
                        clearInterval(timeLapseIntervalRef.current);
                    }
                    return playing;
                });
            };

            // Stop time‑lapse playback when progress slider changes manually
            const onTimeLapseSliderChange = (e) => {
                const value = parseInt(e.target.value);
                setTimeLapseProgress(value);
                if (timeLapsePlaying) {
                    clearInterval(timeLapseIntervalRef.current);
                    setTimeLapsePlaying(false);
                }
            };

            // Upload image
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        setUploadedImage(evt.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Sign out for the admin
            const handleAdminSignOut = () => {
                setIsAdmin(false);
                localStorage.removeItem('adminToken');
                window.location.reload();
            };

            // Refs
            const wallScrollRef = React.useRef(null);
            const wallInnerRef = React.useRef(null);

            // -------------------------------------------------------------------------
            // Render
            //
            // Compose the UI.  The page includes a left sidebar for creating posts,
            // a top navigation bar for campaign selection and zoom controls, and the main
            // board area that displays posts.  The name/edit/like overlay floats
            // above each post, ensuring it does not occupy board space.
            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Navigation / Header */}
                    <div className="bg-white shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                            <h1 className="text-lg font-semibold text-indigo-600">Enhanced Campaign Wall</h1>
                            <div className="flex space-x-2 text-sm">
                                {activeCampaign && (
                                    <>
                                        <span className="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">
                                            {activeCampaign.title}
                                        </span>
                                        <span className="px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">
                                            {activeCampaign.type === 'text' ? 'Text Campaign' : 'Image Campaign'}
                                        </span>
                                    </>
                                )}
                            </div>
                            <div className="flex items-center space-x-4">
                                <span className="text-sm text-gray-600">Signed in as: {userNickname}</span>
                                {isAdmin && (
                                    <button
                                        onClick={handleAdminSignOut}
                                        className="text-sm text-red-600 hover:underline"
                                    >
                                        Admin
                                    </button>
                                )}
                                <button
                                    onClick={() => window.open('https://www.buymeacoffee.com/talkloop', '_blank')}
                                    className="bg-yellow-400 text-black font-medium py-1 px-3 rounded-full flex items-center text-sm hover:bg-yellow-500"
                                >
                                    <i className="fas fa-hand-holding-heart mr-1"></i>
                                    Donate
                                </button>
                            </div>
                        </div>
                    </div>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Left Sidebar */}
                        <div className="w-72 border-r border-gray-200 bg-white overflow-y-auto">
                            <div className="p-4 space-y-6">
                                {/* Campaign Selection */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Select Campaign
                                    </label>
                                    <select
                                        value={activeCampaign ? activeCampaign.id : ''}
                                        onChange={(e) => {
                                            const selected = campaigns.find(c => c.id === e.target.value);
                                            setActiveCampaign(selected);
                                        }}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    >
                                        {campaigns.length === 0 && (
                                            <option value="" disabled>No active campaigns</option>
                                        )}
                                        {campaigns.map(campaign => (
                                            <option key={campaign.id} value={campaign.id}>
                                                {campaign.title}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* Post Creator */}
                                <div>
                                    <h2 className="text-lg font-semibold text-gray-900">Create Your Post</h2>
                                    <p className="text-sm text-gray-600 mb-2">Your Post (max 200 characters)</p>
                                    {activeCampaign && activeCampaign.type === 'text' && (
                                        <textarea
                                            value={confessionText}
                                            onChange={(e) => setConfessionText(e.target.value.slice(0, 200))}
                                            className="w-full h-24 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                            placeholder="Type your post here..."
                                            disabled={!hasCampaign || userHasPosted}
                                        />
                                    )}
                                    {activeCampaign && activeCampaign.type === 'image' && (
                                        <div className="mt-2">
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={handleImageUpload}
                                                disabled={!hasCampaign || userHasPosted}
                                                className="w-full"
                                            />
                                            {uploadedImage && (
                                                <div className="mt-2">
                                                    <img
                                                        src={uploadedImage}
                                                        alt="Preview"
                                                        className="w-full h-32 object-cover border rounded-lg"
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Text color, boundary color, font family, font size, rotation controls only for text posts */}
                                    {activeCampaign && activeCampaign.type === 'text' && (
                                        <>
                                            <div className="mt-3 grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Text Color</label>
                                                    <div className="flex flex-wrap gap-1">
                                                        {['#000000', '#ffffff', '#e11d48', '#10b981', '#3b82f6', '#f97316', '#eab308', '#ec4899'].map(color => (
                                                            <button
                                                                key={color}
                                                                onClick={() => setTextColor(color)}
                                                                className={`w-6 h-6 rounded border ${textColor === color ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}
                                                                style={{ backgroundColor: color }}
                                                                aria-label={`Select color ${color}`}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Boundary Color</label>
                                                    <div className="flex flex-wrap gap-1">
                                                        {['#ffffff', '#000000', '#e11d48', '#10b981', '#3b82f6', '#f97316', '#eab308', '#ec4899'].map(color => (
                                                            <button
                                                                key={color}
                                                                onClick={() => setBoundaryColor(color)}
                                                                className={`w-6 h-6 rounded border ${boundaryColor === color ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}
                                                                style={{ backgroundColor: color }}
                                                                aria-label={`Select color ${color}`}
                                                            />
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="mt-3">
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Font Family</label>
                                                <select
                                                    value={fontFamily}
                                                    onChange={(e) => setFontFamily(e.target.value)}
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                                >
                                                    <option value="Arial">Arial</option>
                                                    <option value="Georgia">Georgia</option>
                                                    <option value="Times New Roman">Times New Roman</option>
                                                    <option value="Courier New">Courier New</option>
                                                    <option value="Comic Sans MS">Comic Sans MS</option>
                                                </select>
                                            </div>
                                            <div className="mt-3 flex items-center">
                                                <label className="block text-sm font-medium text-gray-700 mb-1 mr-3">Font Size: {fontSize}px</label>
                                                <input
                                                    type="range"
                                                    min="12"
                                                    max="32"
                                                    value={fontSize}
                                                    onChange={(e) => setFontSize(parseInt(e.target.value))}
                                                    className="flex-1"
                                                />
                                            </div>
                                        </>
                                    )}

                                    {/* Rotation (common to both text and image posts) */}
                                    {hasCampaign && (
                                        <div className="mt-3 flex items-center">
                                            <label className="block text-sm font-medium text-gray-700 mb-1 mr-3">
                                                Rotation: {rotation}°
                                            </label>
                                            <input
                                                type="range"
                                                min="-45"
                                                max="45"
                                                step="1"
                                                value={rotation}
                                                onChange={(e) => setRotation(parseInt(e.target.value))}
                                                className="flex-1"
                                            />
                                        </div>
                                    )}

                                    {/* Display name */}
                                    <div className="mt-3">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                                        <input
                                            type="text"
                                            value={displayName}
                                            onChange={(e) => setDisplayName(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                            placeholder="Optional name"
                                            disabled={!hasCampaign || userHasPosted}
                                        />
                                    </div>

                                    {/* Placement Mode */}
                                    {hasCampaign && (
                                        <div className="mt-3">
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Placement</label>
                                            <div className="flex space-x-2">
                                                <button
                                                    onClick={() => setPlacementMode('auto')}
                                                    className={`flex-1 py-2 rounded-lg text-sm font-medium ${
                                                        placementMode === 'auto' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                    disabled={userHasPosted}
                                                >
                                                    Auto
                                                </button>
                                                <button
                                                    onClick={() => setPlacementMode('manual')}
                                                    className={`flex-1 py-2 rounded-lg text-sm font-medium ${
                                                        placementMode === 'manual' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                    }`}
                                                    disabled={userHasPosted}
                                                >
                                                    Manual
                                                </button>
                                            </div>
                                            {placementMode === 'manual' && !userHasPosted && (
                                                <p className="mt-1 text-xs text-gray-500">Click on the board to pick your spot.</p>
                                            )}
                                        </div>
                                    )}

                                    {/* Buttons */}
                                    <div className="mt-4 space-y-2">
                                        {hasCampaign && activeCampaign.type === 'text' && (
                                            <button  
                                                onClick={handlePlaceConfession}  
                                                disabled={!hasCampaign || !confessionText.trim() || userHasPosted}  
                                                className={`w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center ${  
                                                    !hasCampaign || !confessionText.trim() || userHasPosted
                                                        ? 'bg-gray-200 text-gray-500 cursor-not-allowed'  
                                                        : 'bg-indigo-600 text-white hover:bg-indigo-700'  
                                                }`}  
                                            >  
                                                {userHasPosted ? (  
                                                    'Already Posted'  
                                                ) : (  
                                                    'Post to Wall'  
                                                )}  
                                            </button>  
                                        )}

                                        {/* Image post submission button */}
                                        {hasCampaign && activeCampaign.type === 'image' && (
                                            <button
                                                onClick={handleSubmitImage}
                                                disabled={!hasCampaign || !uploadedImage || userHasPosted}
                                                className={`w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center ${
                                                    !hasCampaign || !uploadedImage || userHasPosted
                                                        ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                                                        : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                                }`}
                                            >
                                                {userHasPosted ? (
                                                    'Already Posted'
                                                ) : (
                                                    'Post Photo to Wall'
                                                )}
                                            </button>
                                        )}
                                        
                                        <button  
                                            onClick={handleRemoveConfession}  
                                            disabled={!hasCampaign || !userHasPosted}  
                                            className={`w-full py-2 px-4 rounded-xl font-medium transition-all flex items-center justify-center ${  
                                                !hasCampaign || !userHasPosted
                                                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'  
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'  
                                            }`}  
                                        >  
                                            Remove My Post  
                                        </button>  
                                        
                                        <button  
                                            onClick={locateMyConfession}  
                                            disabled={!hasCampaign || !userHasPosted}  
                                            className={`w-full py-2 px-4 rounded-xl font-medium transition-all flex items-center justify-center ${  
                                                !hasCampaign || !userHasPosted
                                                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'  
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'  
                                            }`}  
                                        >  
                                            Find My Post  
                                        </button>  
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Board Area */}
                        <div className="flex-1 flex flex-col overflow-hidden">
                            {/* Toolbar */}
                            <div className="bg-white border-b border-gray-200 py-2 px-4 flex items-center justify-between">
                                <div className="flex items-center space-x-2">
                                    <button onClick={zoomOut} className="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">
                                        <i className="fas fa-minus"></i>
                                    </button>
                                    <span className="text-sm">{Math.round(zoom * 100)}%</span>
                                    <button onClick={zoomIn} className="text-sm px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">
                                        <i className="fas fa-plus"></i>
                                    </button>
                                    <span className="text-sm ml-2">{confessions.length} posts</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button
                                        onClick={toggleTimeLapse}
                                        disabled={!hasCampaign}
                                        className={`text-sm px-3 py-1.5 rounded-lg transition-colors ${
                                            !hasCampaign
                                                ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                : timeLapseMode
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        <i className="fas fa-film mr-1"></i>
                                        Time Lapse
                                    </button>
                                    {/* View Full Campaign button moved to top toolbar */}
                                    <button
                                        onClick={fitToFullContent}
                                        disabled={!hasCampaign || confessions.length === 0}
                                        className={`text-sm px-3 py-1.5 rounded-lg transition-colors ${
                                            !hasCampaign || confessions.length === 0
                                                ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        <i className="fas fa-expand mr-1"></i>
                                        View Full Campaign
                                    </button>
                                </div>  
                            </div>  

                            {/* Time Lapse Controls (below toolbar, only visible when time‑lapse mode is active but not in modal) */}
                            {timeLapseMode && hasCampaign && (
                                <div className="p-3 border-b border-gray-200 bg-gray-50">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-gray-700">Time Lapse</span>
                                        <button 
                                            onClick={toggleTimeLapsePlayback}
                                            className={`px-2 py-1 text-sm rounded ${
                                                timeLapsePlaying ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            }`}
                                        >
                                            {timeLapsePlaying ? 'Stop' : 'Play'}
                                        </button>
                                    </div>
                                    <input
                                        type="range"
                                        min="0"
                                        max="100"
                                        value={timeLapseProgress}
                                        onChange={onTimeLapseSliderChange}
                                        className="w-full"
                                    />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Start</span>
                                        <span>{timeLapseProgress}%</span>
                                        <span>Now</span>
                                    </div>
                                </div>
                            )}

                            {/* Wall container */}
                            <div
                                className="relative flex-1 overflow-auto bg-gray-200"
                                ref={wallScrollRef}
                                onClick={hasCampaign ? (placementMode === 'direct' ? null : onWallClick) : undefined}
                            >
                                {/* Manual placement marker */}
                                {placementMode === 'manual' && pendingManualSpot && (
                                    <div
                                        className="absolute z-40 pointer-events-none"
                                        style={{
                                            left: (pendingManualSpot.x * zoom) - 5,
                                            top: (pendingManualSpot.y * zoom) - 5,
                                            width: 10,
                                            height: 10,
                                            backgroundColor: '#f97316',
                                            borderRadius: '50%',
                                            transform: 'translate(-50%, -50%)',
                                            pointerEvents: 'none'
                                        }}
                                    />
                                )}
                                {/* Inner wall */}
                                <div
                                    ref={wallInnerRef}
                                    className="relative"
                                    style={{
                                        width: `${WALL_WIDTH}px`,
                                        height: `${WALL_HEIGHT}px`,
                                        transform: `scale(${zoom})`,
                                        transformOrigin: 'top left'
                                    }}
                                >
                                    {/* Confessions */}
                                    {hasCampaign && filteredConfessions.map((conf) => (  
                                        <div   
                                            key={conf.id}   
                                            data-conf-id={conf.id}  
                                            className={`absolute select-none transition-transform duration-200 hover:z-50 hover:scale-105 group ${conf.likes === highestLikes && conf.likes > 0 ? 'animate-bounce' : ''}`}  
                                            style={{   
                                                left: `${conf.x}px`,   
                                                top: `${conf.y}px`,   
                                                width: `${conf.w}px`,   
                                                height: `${conf.h}px`,  
                                                transform: `rotate(${conf.rot * 180 / Math.PI}deg)`,  
                                                transformOrigin: 'center'
                                            }}  
                                            onClick={() => {
                                                if (placementMode !== 'manual') {
                                                    setShownConfessionId(prev => prev === conf.id ? null : conf.id);
                                                    clearTimeout(nameTimeoutRef.current);
                                                    nameTimeoutRef.current = setTimeout(() => {
                                                        setShownConfessionId(null);
                                                    }, 5000);
                                                }
                                            }}  
                                        >  
                                            {/* Overlay containing name, like and edit controls.  It floats above the post and does not consume space. */}
                                            <div
                                                className={`absolute top-1 left-1 right-1 flex items-center space-x-1 text-white text-xs z-50 pointer-events-auto ${shownConfessionId === conf.id ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity duration-200`}
                                                onClick={(e) => e.stopPropagation()}
                                            >
                                                <span className="bg-gray-900/80 px-1 rounded">
                                                    {conf.name}
                                                </span>
                                                {/* Like button */}
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        handleLikeConfession(conf.id);
                                                    }}
                                                    className="flex items-center bg-pink-600 hover:bg-pink-700 px-1 py-0.5 rounded"
                                                >
                                                    <i className={`${(conf.liked_by || []).includes(userId) ? 'fas' : 'far'} fa-heart`}></i>
                                                    <span className="ml-1">{conf.likes || 0}</span>
                                                </button>
                                                {/* Edit button for owner */}
                                                {conf.owner === userId && (
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            handleEditConfession(conf.id);
                                                        }}
                                                        className="flex items-center bg-indigo-600 hover:bg-indigo-700 px-1 py-0.5 rounded"
                                                    >
                                                        <i className="fas fa-pen"></i>
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {conf.type === 'text' ? (
                                                <div
                                                    className="w-full h-full flex items-center justify-center text-center p-3"
                                                    style={{
                                                        color: conf.color || '#000000',
                                                        fontFamily: conf.font_family || 'Arial',
                                                        fontSize: `${conf.font_size || 14}px`,
                                                        overflow: 'hidden',
                                                        wordBreak: 'break-word',
                                                        textShadow: `
                                                            1px 1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            -1px -1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            1px -1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            -1px 1px 0 ${conf.boundary_color || '#ffffff'},
                                                            0px 1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            1px 0px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            -1px 0px 0 ${conf.boundary_color || '#ffffff'}, 
                                                            0px -1px 0 ${conf.boundary_color || '#ffffff'}
                                                        `
                                                    }}
                                                >
                                                    {conf.text}
                                                </div>
                                            ) : (
                                                <img
                                                    src={conf.image}
                                                    alt="User submission"
                                                    className="w-full h-full object-cover"
                                                    style={{
                                                        border: '1px solid #e5e7eb',
                                                        borderRadius: '4px'
                                                    }}
                                                />
                                            )}
                                        </div>  
                                    ))}  
                                </div>  
                            </div>  
                            
                            {/* About / Info Section */}
                            <div className="p-4 bg-white border-t border-gray-200">
                                {hasCampaign && (
                                    <div className="mt-4 text-sm text-gray-600">  
                                        <p>✨ Each {activeCampaign.type === 'text' ? 'post' : 'photo'} is styled uniquely, creating a beautiful mosaic of shared experiences.</p>  
                                        <p className="mt-1">🖱️ Scroll to explore, zoom in/out, and click on items to see who posted them.</p>  
                                    </div>  
                                )}
                            </div>
                        </div>  
                    </main>

                    {/* Edit Modal */}
                    {editingPostId && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">Edit Your Post</h3>
                                
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Text Color</label>
                                        <div className="flex flex-wrap gap-1">
                                            {['#000000', '#ffffff', '#e11d48', '#10b981', '#3b82f6', '#f97316', '#eab308', '#ec4899'].map(color => (
                                                <button
                                                    key={color}
                                                    onClick={() => setEditTextColor(color)}
                                                    className={`w-6 h-6 rounded border ${editTextColor === color ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}
                                                    style={{ backgroundColor: color }}
                                                    aria-label={`Select color ${color}`}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Boundary Color</label>
                                        <div className="flex flex-wrap gap-1">
                                            {['#ffffff', '#000000', '#e11d48', '#10b981', '#3b82f6', '#f97316', '#eab308', '#ec4899'].map(color => (
                                                <button
                                                    key={color}
                                                    onClick={() => setEditBoundaryColor(color)}
                                                    className={`w-6 h-6 rounded border ${editBoundaryColor === color ? 'ring-2 ring-offset-2 ring-indigo-300' : ''}`}
                                                    style={{ backgroundColor: color }}
                                                    aria-label={`Select color ${color}`}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Font Family</label>
                                    <select
                                        value={editFontFamily}
                                        onChange={(e) => setEditFontFamily(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    >
                                        <option value="Arial">Arial</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Comic Sans MS">Comic Sans MS</option>
                                    </select>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Font Size: {editFontSize}px</label>
                                    <input
                                        type="range"
                                        min="12"
                                        max="32"
                                        value={editFontSize}
                                        onChange={(e) => setEditFontSize(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Rotation: {editRotation}°</label>
                                    <input
                                        type="range"
                                        min="-45"
                                        max="45"
                                        value={editRotation}
                                        onChange={(e) => setEditRotation(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                </div>
                                <div className="flex justify-end space-x-2">
                                    <button
                                        onClick={() => setEditingPostId(null)}
                                        className="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSaveEdit}
                                        className="px-4 py-2 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Time Lapse Modal */}
                    {timeLapseMode && showTimeLapseModal && hasCampaign && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
                            <div className="bg-white rounded-xl shadow-xl p-4 w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-lg font-semibold text-gray-900">Campaign Time Lapse</h3>
                                    <button
                                        onClick={() => {
                                            setTimeLapseMode(false);
                                            setShowTimeLapseModal(false);
                                            setTimeLapsePlaying(false);
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                                <div className="flex-1 overflow-auto bg-gray-100 border border-gray-200 rounded relative">
                                    <div
                                        className="relative"
                                        style={{
                                            width: `${WALL_WIDTH}px`,
                                            height: `${WALL_HEIGHT}px`,
                                            transform: 'scale(0.12)',
                                            transformOrigin: 'top left'
                                        }}
                                    >
                                        {filteredConfessions.map((conf) => (
                                            <div
                                                key={conf.id}
                                                className={`absolute select-none ${conf.likes === highestLikes && conf.likes > 0 ? 'animate-bounce' : ''}`}
                                                style={{
                                                    left: `${conf.x}px`,
                                                    top: `${conf.y}px`,
                                                    width: `${conf.w}px`,
                                                    height: `${conf.h}px`,
                                                    transform: `rotate(${conf.rot * 180 / Math.PI}deg)`,
                                                    transformOrigin: 'center'
                                                }}
                                            >
                                                {conf.type === 'text' ? (
                                                    <div
                                                        className="w-full h-full flex items-center justify-center text-center p-1"
                                                        style={{
                                                            color: conf.color || '#000000',
                                                            fontFamily: conf.font_family || 'Arial',
                                                            fontSize: `${conf.font_size || 14}px`,
                                                            overflow: 'hidden',
                                                            wordBreak: 'break-word',
                                                            textShadow: `
                                                                1px 1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                -1px -1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                1px -1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                -1px 1px 0 ${conf.boundary_color || '#ffffff'},
                                                                0px 1px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                1px 0px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                -1px 0px 0 ${conf.boundary_color || '#ffffff'}, 
                                                                0px -1px 0 ${conf.boundary_color || '#ffffff'}
                                                            `
                                                        }}
                                                    >
                                                        {conf.text}
                                                    </div>
                                                ) : (
                                                    <img
                                                        src={conf.image}
                                                        alt="User submission"
                                                        className="w-full h-full object-cover"
                                                        style={{
                                                            border: '1px solid #e5e7eb',
                                                            borderRadius: '4px'
                                                        }}
                                                    />
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="mt-4">
                                    <div className="flex items-center justify-between mb-1">
                                        <span className="text-sm font-medium text-gray-700">Playback</span>
                                        <button 
                                            onClick={toggleTimeLapsePlayback}
                                            className={`px-2 py-1 text-sm rounded ${
                                                timeLapsePlaying ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'
                                            }`}
                                        >
                                            {timeLapsePlaying ? 'Stop' : 'Play'}
                                        </button>
                                    </div>
                                    <input
                                        type="range"
                                        min="0"
                                        max="100"
                                        value={timeLapseProgress}
                                        onChange={onTimeLapseSliderChange}
                                        className="w-full"
                                    />
                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>Start</span>
                                        <span>{timeLapseProgress}%</span>
                                        <span>Now</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<EnhancedCampaignBoard />, document.getElementById('root'));
    </script>
</body>
</html>
