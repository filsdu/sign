<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div id="admin-root"></div>
    <script type="text/babel">
        function AdminPanel() {
            const SUPABASE_URL = 'https://swurygicmrkbdgqbzhmp.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3dXJ5Z2ljbXJrYmRncWJ6aG1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTE0NDUsImV4cCI6MjA3MTcyNzQ0NX0.u9IB0nxe2UmR3AOZ5-MY6_A_WJK-YY8Z9mF8EYBH3Gk';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const [campaigns, setCampaigns] = React.useState([]);
            const [confessions, setConfessions] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [filterText, setFilterText] = React.useState('');
            const [statusFilter, setStatusFilter] = React.useState('all');
            const [dateRange, setDateRange] = React.useState({start: '', end: ''});
            const [errorMessage, setErrorMessage] = React.useState('');

            // Admin authentication (simple token check)
            React.useEffect(() => {
                const token = localStorage.getItem('adminToken');
                if (!token || token !== 'valid-admin-token') {
                    window.location.href = '/';
                }
            }, []);

            React.useEffect(() => {
                const fetchData = async () => {
                    try {
                        const { data: campaignsData } = await supabaseClient
                            .from('campaigns')
                            .select('*')
                            .order('created_at', { ascending: true });

                        const { data: confessionsData } = await supabaseClient
                            .from('confessions')
                            .select('*')
                            .order('created_at', { ascending: true });

                        setCampaigns(campaignsData);
                        setConfessions(confessionsData);
                    } catch (error) {
                        setErrorMessage('Failed to load data.');
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, []);

            const deleteConfession = async (id) => {
                if (!window.confirm('Are you sure you want to delete this post?')) return;
                try {
                    await supabaseClient
                        .from('confessions')
                        .delete()
                        .eq('id', id);
                    setConfessions(prev => prev.filter(c => c.id !== id));
                } catch (err) {
                    alert('Failed to delete post.');
                }
            };

            const filteredConfessions = React.useMemo(() => {
                return confessions.filter(conf => {
                    if (filterText && conf.type === 'text' && !conf.text.toLowerCase().includes(filterText.toLowerCase())) {
                        return false;
                    }
                    if (statusFilter !== 'all' && statusFilter !== conf.type) {
                        return false;
                    }
                    if (dateRange.start && new Date(conf.created_at) < new Date(dateRange.start)) {
                        return false;
                    }
                    if (dateRange.end && new Date(conf.created_at) > new Date(dateRange.end)) {
                        return false;
                    }
                    return true;
                });
            }, [confessions, filterText, statusFilter, dateRange]);

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <span>Loading...</span>
                    </div>
                );
            }

            return (
                <div className="max-w-6xl mx-auto py-10 px-4">
                    <h1 className="text-2xl font-semibold mb-6">Admin Panel</h1>
                    {errorMessage && <div className="mb-4 text-red-600">{errorMessage}</div>}

                    <div className="grid grid-cols-3 gap-6 mb-8">
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-xl font-semibold mb-2">Create New Campaign</h2>
                            <CreateCampaignForm supabaseClient={supabaseClient} />
                        </div>

                        <div className="bg-white rounded-lg shadow p-6 col-span-2">
                            <h2 className="text-xl font-semibold mb-4">Current Campaigns</h2>
                            <CampaignList campaigns={campaigns} />
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-semibold mb-4">Manage Posts</h2>
                        <div className="mb-4">
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Search Text</label>
                                    <input
                                        type="text"
                                        value={filterText}
                                        onChange={e => setFilterText(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Type</label>
                                    <select
                                        value={statusFilter}
                                        onChange={e => setStatusFilter(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    >
                                        <option value="all">All</option>
                                        <option value="text">Text</option>
                                        <option value="image">Image</option>
                                    </select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">Start Date</label>
                                        <input
                                            type="date"
                                            value={dateRange.start}
                                            onChange={e => setDateRange({...dateRange, start: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 uppercase mb-1">End Date</label>
                                        <input
                                            type="date"
                                            value={dateRange.end}
                                            onChange={e => setDateRange({...dateRange, end: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                        />
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end mt-2">
                                <button
                                    onClick={() => {
                                        setFilterText('');
                                        setStatusFilter('all');
                                        setDateRange({start: '', end: ''});
                                    }}
                                    className="text-sm text-gray-600 hover:text-gray-800"
                                >
                                    Clear Filters
                                </button>
                            </div>
                        </div>

                        <div className="bg-white shadow overflow-hidden rounded-lg">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Content</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Likes</th>
                                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredConfessions.length > 0 ? (
                                        filteredConfessions.map(confession => (
                                            <tr key={confession.id}>
                                                <td className="px-6 py-4">
                                                    <div className="text-sm font-medium text-gray-900">
                                                        {confession.type === 'text' ? (
                                                            <div className="max-w-xs truncate">"{confession.text}"</div>
                                                        ) : (
                                                            <div className="flex items-center">
                                                                <i className="fas fa-image text-purple-500 mr-1"></i>
                                                                <span>Image Post</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-xs text-gray-500">ID: {confession.id}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm text-gray-900">{confession.name}</div>
                                                    <div className="text-xs text-gray-500">User ID: {confession.owner}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {campaigns.find(c => c.id === confession.campaign_id)?.title || 'Unknown'}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {new Date(confession.created_at).toLocaleDateString()}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    {confession.likes || 0}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button
                                                        onClick={() => deleteConfession(confession.id)}
                                                        className="text-red-600 hover:text-red-900"
                                                    >
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td
                                                colSpan="6"
                                                className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center"
                                            >
                                                No posts found.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function CreateCampaignForm({ supabaseClient }) {
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [type, setType] = React.useState('text');
            const [errorMsg, setErrorMsg] = React.useState('');
            const [successMsg, setSuccessMsg] = React.useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!title.trim()) {
                    setErrorMsg('Title is required');
                    return;
                }
                if (!description.trim()) {
                    setErrorMsg('Description is required');
                    return;
                }

                try {
                    const { error } = await supabaseClient
                        .from('campaigns')
                        .insert({
                            title,
                            description,
                            type,
                            is_active: true,
                            created_at: new Date().toISOString()
                        });
                    if (error) {
                        console.error('Error creating campaign:', error);
                        setErrorMsg('Failed to create campaign');
                    } else {
                        setSuccessMsg('Campaign created successfully');
                        setTitle('');
                        setDescription('');
                        setType('text');
                    }
                } catch (err) {
                    console.error('Unexpected error creating campaign:', err);
                    setErrorMsg('An unexpected error occurred');
                }
            };

            return (
                <form onSubmit={handleSubmit}>
                    {errorMsg && <div className="mb-2 text-red-600 text-sm">{errorMsg}</div>}
                    {successMsg && <div className="mb-2 text-green-600 text-sm">{successMsg}</div>}
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Campaign Title</label>
                        <input
                            type="text"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea
                            value={description}
                            onChange={(e) => setDescription(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        />
                    </div>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">Campaign Type</label>
                        <select
                            value={type}
                            onChange={(e) => setType(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        >
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                    <button
                        type="submit"
                        className="px-4 py-2 text-white bg-indigo-600 rounded hover:bg-indigo-700"
                    >
                        Create Campaign
                    </button>
                </form>
            );
        }

        function CampaignList({ campaigns }) {
            const [selectedId, setSelectedId] = React.useState(null);

            const toggleActiveState = async (campaign) => {
                try {
                    const { error } = await supabaseClient
                        .from('campaigns')
                        .update({ is_active: !campaign.is_active })
                        .eq('id', campaign.id);
                    if (error) {
                        alert('Failed to update campaign status');
                    } else {
                        window.location.reload();
                    }
                } catch (err) {
                    alert('Unexpected error');
                }
            };

            return (
                <div className="space-y-4">
                    {campaigns.map(campaign => (
                        <div key={campaign.id} className="p-4 border rounded-lg bg-gray-50">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h3 className="font-semibold text-gray-800">{campaign.title}</h3>
                                    <p className="text-sm text-gray-600">{campaign.description}</p>
                                    <p className="text-xs text-gray-500 mt-1">Created at {new Date(campaign.created_at).toLocaleString()}</p>
                                    <span className={`mt-1 inline-block px-2 py-0.5 rounded-full text-xs font-medium ${
                                        campaign.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        {campaign.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                                <div className="flex space-x-2 items-center">
                                    <button
                                        onClick={() => toggleActiveState(campaign)}
                                        className={`px-2 py-1 text-xs rounded ${
                                            campaign.is_active ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-green-500 text-white hover:bg-green-600'
                                        }`}
                                    >
                                        {campaign.is_active ? 'Deactivate' : 'Activate'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        ReactDOM.render(<AdminPanel />, document.getElementById('admin-root'));
    </script>
</body>
</html>
